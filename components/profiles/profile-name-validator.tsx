'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Badge } from '@/components/ui/badge';\nimport { CheckCircle, AlertTriangle, AlertCircle, Loader2 } from 'lucide-react';\nimport { useValidation } from '@/hooks/use-validation';\nimport { debounce } from 'lodash';\n\ninterface ProfileNameValidatorProps {\n  value: string;\n  onChange: (value: string, isValid: boolean) => void;\n  label?: string;\n  placeholder?: string;\n  disabled?: boolean;\n}\n\nexport function ProfileNameValidator({\n  value,\n  onChange,\n  label = \"Nome profilo\",\n  placeholder = \"Inserisci il nome del profilo\",\n  disabled = false\n}: ProfileNameValidatorProps) {\n  const [validation, setValidation] = useState<any>(null);\n  const [isValidating, setIsValidating] = useState(false);\n  const [isUnique, setIsUnique] = useState<boolean | null>(null);\n  const { validateProfileName, validateUniqueProfileName, config } = useValidation();\n\n  // Debounced validation\n  const debouncedValidate = useCallback(\n    debounce(async (name: string) => {\n      if (!name.trim()) {\n        setValidation(null);\n        setIsUnique(null);\n        onChange(name, false);\n        return;\n      }\n\n      setIsValidating(true);\n      \n      try {\n        // Valida nome\n        const nameResult = await validateProfileName(name);\n        setValidation(nameResult);\n        \n        // Se il nome è valido, controlla unicità\n        if (nameResult?.is_valid) {\n          const uniqueResult = await validateUniqueProfileName(name);\n          setIsUnique(uniqueResult);\n          onChange(name, uniqueResult);\n        } else {\n          setIsUnique(null);\n          onChange(name, false);\n        }\n      } catch (error) {\n        console.error('Errore validazione nome:', error);\n        onChange(name, false);\n      } finally {\n        setIsValidating(false);\n      }\n    }, 300),\n    [validateProfileName, validateUniqueProfileName, onChange]\n  );\n\n  // Effettua validazione quando il valore cambia\n  useEffect(() => {\n    debouncedValidate(value);\n    return () => {\n      debouncedValidate.cancel();\n    };\n  }, [value, debouncedValidate]);\n\n  // Determina lo stato di validazione\n  const getValidationState = () => {\n    if (isValidating) return 'validating';\n    if (!value.trim()) return 'empty';\n    if (!validation) return 'unknown';\n    if (!validation.is_valid) return 'invalid';\n    if (isUnique === false) return 'not_unique';\n    if (isUnique === true) return 'valid';\n    return 'checking';\n  };\n\n  const validationState = getValidationState();\n\n  // Ottieni icona per lo stato\n  const getValidationIcon = () => {\n    switch (validationState) {\n      case 'validating':\n      case 'checking':\n        return <Loader2 className=\"h-4 w-4 animate-spin text-blue-500\" />;\n      case 'valid':\n        return <CheckCircle className=\"h-4 w-4 text-green-500\" />;\n      case 'invalid':\n      case 'not_unique':\n        return <AlertCircle className=\"h-4 w-4 text-red-500\" />;\n      case 'empty':\n      case 'unknown':\n      default:\n        return null;\n    }\n  };\n\n  // Ottieni colore bordo input\n  const getInputBorderColor = () => {\n    switch (validationState) {\n      case 'valid':\n        return 'border-green-500 focus:border-green-500';\n      case 'invalid':\n      case 'not_unique':\n        return 'border-red-500 focus:border-red-500';\n      case 'validating':\n      case 'checking':\n        return 'border-blue-500 focus:border-blue-500';\n      default:\n        return '';\n    }\n  };\n\n  return (\n    <div className=\"space-y-2\">\n      <Label htmlFor=\"profile-name\">{label}</Label>\n      \n      <div className=\"relative\">\n        <Input\n          id=\"profile-name\"\n          type=\"text\"\n          value={value}\n          onChange={(e) => onChange(e.target.value, false)}\n          placeholder={placeholder}\n          disabled={disabled}\n          className={`pr-10 ${getInputBorderColor()}`}\n          maxLength={config?.max_profile_name_length || 32}\n        />\n        \n        <div className=\"absolute inset-y-0 right-0 flex items-center pr-3\">\n          {getValidationIcon()}\n        </div>\n      </div>\n      \n      {/* Informazioni configurazione */}\n      {config && (\n        <div className=\"flex flex-wrap gap-1 text-xs text-muted-foreground\">\n          <Badge variant=\"outline\" className=\"text-xs\">\n            {config.min_profile_name_length}-{config.max_profile_name_length} caratteri\n          </Badge>\n          <Badge variant=\"outline\" className=\"text-xs\">\n            Solo lettere, numeri, spazi, - e _\n          </Badge>\n        </div>\n      )}\n      \n      {/* Errori validazione */}\n      {validation && validation.errors.length > 0 && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription>\n            <ul className=\"list-disc list-inside space-y-1\">\n              {validation.errors.map((error: string, index: number) => (\n                <li key={index}>{error}</li>\n              ))}\n            </ul>\n          </AlertDescription>\n        </Alert>\n      )}\n      \n      {/* Errore unicità */}\n      {isUnique === false && (\n        <Alert variant=\"destructive\">\n          <AlertCircle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Questo nome è già in uso. Scegli un nome diverso.\n          </AlertDescription>\n        </Alert>\n      )}\n      \n      {/* Warning validazione */}\n      {validation && validation.warnings.length > 0 && (\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            <ul className=\"list-disc list-inside space-y-1\">\n              {validation.warnings.map((warning: string, index: number) => (\n                <li key={index}>{warning}</li>\n              ))}\n            </ul>\n          </AlertDescription>\n        </Alert>\n      )}\n      \n      {/* Nome sanitizzato */}\n      {validation && validation.sanitized_name !== value && (\n        <Alert>\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertDescription>\n            Il nome verrà salvato come: <strong>{validation.sanitized_name}</strong>\n          </AlertDescription>\n        </Alert>\n      )}\n      \n      {/* Successo */}\n      {validationState === 'valid' && (\n        <Alert className=\"border-green-200 bg-green-50\">\n          <CheckCircle className=\"h-4 w-4 text-green-600\" />\n          <AlertDescription className=\"text-green-800\">\n            Nome profilo valido e disponibile!\n          </AlertDescription>\n        </Alert>\n      )}\n    </div>\n  );\n}"