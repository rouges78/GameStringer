'use client';\n\nimport { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Checkbox } from '@/components/ui/checkbox';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Progress } from '@/components/ui/progress';\nimport { toast } from 'sonner';\nimport { Download, Upload, AlertTriangle, CheckCircle, Loader2, Database, Shield } from 'lucide-react';\nimport { invoke } from '@/lib/tauri-api';\nimport { format } from 'date-fns';\nimport { it } from 'date-fns/locale';\n\ninterface LegacyCredentialInfo {\n  store: string;\n  file_path: string;\n  created_at: string;\n  file_size: number;\n}\n\ninterface MigrationResult {\n  migrated_stores: string[];\n  failed_stores: [string, string][];\n  total_migrated: number;\n  total_failed: number;\n  migrated_at: string;\n}\n\ninterface MigrationWizardResult {\n  steps: string[];\n  errors: string[];\n  backup_path?: string;\n  migration_result?: MigrationResult;\n  completed_at: string;\n}\n\ninterface MigrationWizardProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onComplete: () => void;\n}\n\nexport function MigrationWizard({ isOpen, onClose, onComplete }: MigrationWizardProps) {\n  const [step, setStep] = useState(0);\n  const [isLoading, setIsLoading] = useState(false);\n  const [hasLegacyCredentials, setHasLegacyCredentials] = useState(false);\n  const [legacyInfo, setLegacyInfo] = useState<LegacyCredentialInfo[]>([]);\n  const [createBackup, setCreateBackup] = useState(true);\n  const [migrationResult, setMigrationResult] = useState<MigrationWizardResult | null>(null);\n  const [progress, setProgress] = useState(0);\n\n  const steps = [\n    'Verifica credenziali legacy',\n    'Configurazione migrazione',\n    'Esecuzione migrazione',\n    'Completamento'\n  ];\n\n  // Verifica credenziali legacy all'apertura\n  useEffect(() => {\n    if (isOpen) {\n      checkLegacyCredentials();\n    }\n  }, [isOpen]);\n\n  const checkLegacyCredentials = async () => {\n    setIsLoading(true);\n    try {\n      const hasLegacy = await invoke<any>('check_legacy_credentials');\n      if (hasLegacy.success && hasLegacy.data) {\n        setHasLegacyCredentials(true);\n        \n        // Ottieni informazioni dettagliate\n        const info = await invoke<any>('get_legacy_credentials_info');\n        if (info.success) {\n          setLegacyInfo(info.data || []);\n        }\n      } else {\n        setHasLegacyCredentials(false);\n      }\n    } catch (error) {\n      console.error('Errore verifica credenziali legacy:', error);\n      toast.error('Errore durante la verifica delle credenziali legacy');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const nextStep = () => {\n    if (step < steps.length - 1) {\n      setStep(step + 1);\n      setProgress(((step + 1) / steps.length) * 100);\n    }\n  };\n\n  const prevStep = () => {\n    if (step > 0) {\n      setStep(step - 1);\n      setProgress((step / steps.length) * 100);\n    }\n  };\n\n  const executeMigration = async () => {\n    setIsLoading(true);\n    try {\n      const result = await invoke<any>('migration_wizard', {\n        createBackup\n      });\n\n      if (result.success) {\n        setMigrationResult(result.data);\n        toast.success('Migrazione completata con successo!');\n        nextStep();\n      } else {\n        toast.error(`Errore durante la migrazione: ${result.error}`);\n      }\n    } catch (error) {\n      console.error('Errore migrazione:', error);\n      toast.error('Errore durante la migrazione');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleClose = () => {\n    setStep(0);\n    setProgress(0);\n    setMigrationResult(null);\n    onClose();\n  };\n\n  const handleComplete = () => {\n    onComplete();\n    handleClose();\n  };\n\n  const renderStepContent = () => {\n    switch (step) {\n      case 0: // Verifica credenziali legacy\n        return (\n          <div className=\"space-y-4\">\n            {isLoading ? (\n              <div className=\"flex items-center justify-center py-8\">\n                <Loader2 className=\"h-8 w-8 animate-spin\" />\n                <span className=\"ml-2\">Verifica credenziali legacy...</span>\n              </div>\n            ) : hasLegacyCredentials ? (\n              <div className=\"space-y-4\">\n                <Alert>\n                  <CheckCircle className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    Trovate credenziali legacy da migrare!\n                  </AlertDescription>\n                </Alert>\n                \n                <div className=\"space-y-2\">\n                  <h4 className=\"font-medium\">Credenziali trovate:</h4>\n                  {legacyInfo.map((info, index) => (\n                    <div key={index} className=\"flex items-center justify-between p-3 border rounded-md\">\n                      <div className=\"flex items-center\">\n                        <Database className=\"h-4 w-4 mr-2 text-blue-500\" />\n                        <div>\n                          <p className=\"font-medium\">{info.store}</p>\n                          <p className=\"text-sm text-muted-foreground\">\n                            Creato: {format(new Date(info.created_at), 'PPpp', { locale: it })}\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">\n                        {(info.file_size / 1024).toFixed(1)} KB\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            ) : (\n              <Alert>\n                <AlertTriangle className=\"h-4 w-4\" />\n                <AlertDescription>\n                  Nessuna credenziale legacy trovata. La migrazione non Ã¨ necessaria.\n                </AlertDescription>\n              </Alert>\n            )}\n          </div>\n        );\n\n      case 1: // Configurazione migrazione\n        return (\n          <div className=\"space-y-4\">\n            <div className=\"space-y-4\">\n              <h4 className=\"font-medium\">Opzioni migrazione</h4>\n              \n              <div className=\"flex items-center space-x-2\">\n                <Checkbox \n                  id=\"backup\" \n                  checked={createBackup} \n                  onCheckedChange={(checked) => setCreateBackup(checked as boolean)}\n                />\n                <label htmlFor=\"backup\" className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\">\n                  Crea backup delle credenziali legacy prima della migrazione\n                </label>\n              </div>\n              \n              {createBackup && (\n                <Alert>\n                  <Shield className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    Le credenziali legacy verranno salvate in un file di backup prima di essere migrate.\n                  </AlertDescription>\n                </Alert>\n              )}\n            </div>\n            \n            <Alert>\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertDescription>\n                <strong>Importante:</strong> Dopo la migrazione, le credenziali legacy verranno rimosse dal sistema.\n                Assicurati di aver effettuato l'accesso al profilo corretto.\n              </AlertDescription>\n            </Alert>\n          </div>\n        );\n\n      case 2: // Esecuzione migrazione\n        return (\n          <div className=\"space-y-4\">\n            {isLoading ? (\n              <div className=\"space-y-4\">\n                <div className=\"flex items-center justify-center py-4\">\n                  <Loader2 className=\"h-8 w-8 animate-spin\" />\n                  <span className=\"ml-2\">Migrazione in corso...</span>\n                </div>\n                <Progress value={progress} className=\"w-full\" />\n              </div>\n            ) : migrationResult ? (\n              <div className=\"space-y-4\">\n                <Alert>\n                  <CheckCircle className=\"h-4 w-4\" />\n                  <AlertDescription>\n                    Migrazione completata!\n                  </AlertDescription>\n                </Alert>\n                \n                <div className=\"space-y-2\">\n                  <h4 className=\"font-medium\">Risultati:</h4>\n                  {migrationResult.steps.map((step, index) => (\n                    <div key={index} className=\"flex items-center text-sm\">\n                      <CheckCircle className=\"h-4 w-4 mr-2 text-green-500\" />\n                      {step}\n                    </div>\n                  ))}\n                  \n                  {migrationResult.errors.length > 0 && (\n                    <div className=\"space-y-1\">\n                      <h5 className=\"font-medium text-red-600\">Errori:</h5>\n                      {migrationResult.errors.map((error, index) => (\n                        <div key={index} className=\"flex items-center text-sm text-red-600\">\n                          <AlertTriangle className=\"h-4 w-4 mr-2\" />\n                          {error}\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-center py-4\">\n                <Button onClick={executeMigration} disabled={isLoading}>\n                  Avvia migrazione\n                </Button>\n              </div>\n            )}\n          </div>\n        );\n\n      case 3: // Completamento\n        return (\n          <div className=\"space-y-4 text-center\">\n            <CheckCircle className=\"h-16 w-16 mx-auto text-green-500\" />\n            <h3 className=\"text-lg font-medium\">Migrazione completata!</h3>\n            \n            {migrationResult?.migration_result && (\n              <div className=\"space-y-2\">\n                <p className=\"text-sm text-muted-foreground\">\n                  {migrationResult.migration_result.total_migrated} credenziali migrate con successo\n                </p>\n                \n                {migrationResult.backup_path && (\n                  <p className=\"text-xs text-muted-foreground\">\n                    Backup salvato in: {migrationResult.backup_path}\n                  </p>\n                )}\n              </div>\n            )}\n            \n            <p className=\"text-sm text-muted-foreground\">\n              Le tue credenziali sono ora disponibili nel profilo attivo.\n            </p>\n          </div>\n        );\n\n      default:\n        return null;\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={handleClose}>\n      <DialogContent className=\"max-w-2xl\">\n        <DialogHeader>\n          <DialogTitle>Migrazione Credenziali Legacy</DialogTitle>\n          <DialogDescription>\n            Migra le credenziali esistenti al nuovo sistema di profili\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-6\">\n          {/* Progress indicator */}\n          <div className=\"space-y-2\">\n            <div className=\"flex justify-between text-sm\">\n              <span>Passo {step + 1} di {steps.length}</span>\n              <span>{steps[step]}</span>\n            </div>\n            <Progress value={progress} className=\"w-full\" />\n          </div>\n          \n          {/* Step content */}\n          <div className=\"min-h-[300px]\">\n            {renderStepContent()}\n          </div>\n        </div>\n        \n        <DialogFooter>\n          <div className=\"flex justify-between w-full\">\n            <Button \n              variant=\"outline\" \n              onClick={prevStep} \n              disabled={step === 0 || isLoading}\n            >\n              Indietro\n            </Button>\n            \n            <div className=\"space-x-2\">\n              <Button variant=\"outline\" onClick={handleClose}>\n                {step === steps.length - 1 ? 'Chiudi' : 'Annulla'}\n              </Button>\n              \n              {step < steps.length - 1 ? (\n                <Button \n                  onClick={nextStep} \n                  disabled={isLoading || (step === 0 && !hasLegacyCredentials)}\n                >\n                  Avanti\n                </Button>\n              ) : (\n                <Button onClick={handleComplete}>\n                  Completa\n                </Button>\n              )}\n            </div>\n          </div>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}"